<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<title>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¥½è­œã‚¨ãƒ‡ã‚£ã‚¿ + OSMD (å’ŒéŸ³å¼·åŒ–ç‰ˆ)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- OSMD CDN -->
	<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.6/build/opensheetmusicdisplay.min.js"></script>

	<style>
		/* Tailwind CSS ã®ä»£ã‚ã‚Šã¨ã—ã¦ã€ä»¥å‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã‚’å¼·åŒ– */
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body {
			font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
			background: #020617;
			color: #e5e7eb;
			padding: 16px;
		}
		.app {
			max-width: 1024px;
			margin: 0 auto;
			background: #020617;
			border-radius: 16px;
			border: 1px solid #1e293b;
			padding: 16px;
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
		h1 {
			text-align: center;
			font-size: 1.3rem;
			margin-bottom: 4px;
		}
		.subtitle {
			text-align: center;
			font-size: 0.85rem;
			opacity: 0.8;
			color: #38bdf8;
			font-weight: 600;
		}

		/* OSMD ã‚¨ãƒªã‚¢ */
		.osmd-panel {
			background: #0b1120;
			border-radius: 12px;
			border: 1px solid #1e293b;
			padding: 10px;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}
		.osmd-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 0.9rem;
		}
		#osmd-container {
			background: #ffffff;
			border-radius: 8px;
			padding: 8px;
			max-height: 360px;
			overflow: auto;
		}
		.osmd-hint {
			font-size: 0.8rem;
			opacity: 0.8;
		}

		.status-bar {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			padding: 8px;
			background: #0b1120;
			border-radius: 12px;
			border: 1px solid #1e293b;
			font-size: 0.85rem;
		}
		.status-item {
			background: #111827;
			border-radius: 999px;
			border: 1px solid #1f2937;
			padding: 4px 10px;
		}
		.status-label {
			opacity: 0.75;
			margin-right: 4px;
		}
		.status-value {
			font-weight: 600;
		}
		.pending {
			color: #facc15;
			font-weight: 600;
		}
		.chord {
			color: #38bdf8;
			font-weight: 600;
		}
		.chord-mode {
			background: #1e293b;
			color: #38bdf8;
			border-color: #38bdf8;
		}

		.layout {
			display: grid;
			grid-template-columns: 1.1fr 1.1fr;
			gap: 14px;
		}
		@media (max-width: 860px) {
			.layout {
				grid-template-columns: 1fr;
			}
		}

		.panel {
			background: #0b1120;
			border-radius: 12px;
			border: 1px solid #1e293b;
			padding: 10px;
			font-size: 0.86rem;
		}
		.panel h2 {
			font-size: 1rem;
			margin-bottom: 6px;
			border-bottom: 1px solid #1f2937;
			padding-bottom: 4px;
		}
		.panel p {
			line-height: 1.5;
		}
		code {
			font-family: "JetBrains Mono", "Fira Code", monospace;
			background: #020617;
			padding: 1px 4px;
			border-radius: 4px;
			font-size: 0.80rem;
		}

		.event-list {
			list-style: none;
			max-height: 340px;
			overflow-y: auto;
			font-size: 0.86rem;
			margin-top: 4px;
		}
		.event-item {
			padding: 4px 6px;
			border-radius: 6px;
			background: rgba(148, 163, 184, 0.1);
			margin-bottom: 4px;
			cursor: pointer;
			display: flex;
			gap: 6px;
			align-items: center;
		}
		.event-item.selected {
			background: rgba(250, 204, 21, 0.18);
			box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.8);
		}
		.event-item.chord {
			background: rgba(56, 189, 248, 0.1);
			border-left: 3px solid #38bdf8;
		}
		.event-index {
			opacity: 0.7;
			font-size: 0.75rem;
			min-width: 30px;
		}
		.event-meta {
			font-size: 0.75rem;
			color: #9ca3af;
		}
		.chord-indicator {
			color: #38bdf8;
			font-weight: bold;
			margin-left: 4px;
		}

		.btn-row {
			margin-top: 8px;
			display: flex;
			justify-content: flex-end;
			gap: 8px;
		}
		button {
			border: none;
			border-radius: 999px;
			padding: 7px 14px;
			font-size: 0.9rem;
			font-weight: 600;
			cursor: pointer;
		}
		.btn-primary {
			background: #22c55e;
			color: #022c22;
		}
		.btn-secondary {
			background: #111827;
			color: #e5e7eb;
			border: 1px solid #374151;
		}
		.instruction-highlight {
			background: rgba(56, 189, 248, 0.1);
			padding: 4px 8px;
			border-radius: 6px;
			border: 1px solid rgba(56, 189, 248, 0.3);
			margin: 8px 0;
		}
	</style>
</head>
<body>
	<div class="app">
		<div>
			<h1>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¥½è­œã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆå’ŒéŸ³å¼·åŒ–ç‰ˆï¼‰</h1>
			<div class="subtitle">
				âš¡ éŸ³å+ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã§éŸ³ç¬¦æŒ¿å…¥ | Shift+æ•°å­—ã§å’ŒéŸ³è¿½åŠ  | Hã‚­ãƒ¼ã§å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
			</div>
		</div>

		<!-- OSMD ãƒ‘ãƒãƒ« -->
		<section class="osmd-panel">
			<div class="osmd-header">
				<span>OSMD è­œé¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
				<span class="osmd-hint">â€» ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ç·¨é›†ã™ã‚‹ã¨è‡ªå‹•æ›´æ–°</span>
			</div>
			<div id="osmd-container">
				MusicXML ã‹ã‚‰è­œé¢ã‚’ç”Ÿæˆä¸­â€¦
			</div>
		</section>

		<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
		<div class="status-bar">
			<div class="status-item">
				<span class="status-label">ç¾åœ¨éŸ³é«˜:</span>
				<span id="statusPitch" class="status-value">C4</span>
			</div>
			<div class="status-item">
				<span class="status-label">éŸ³ä¾¡:</span>
				<span id="statusDuration" class="status-value">quarter</span>
			</div>
			<div class="status-item">
				<span class="status-label">è‡¨æ™‚è¨˜å·:</span>
				<span id="statusAccidental" class="status-value">ãªã—</span>
			</div>
			<div class="status-item">
				<span class="status-label">ã‚¤ãƒ™ãƒ³ãƒˆæ•°:</span>
				<span id="statusCount" class="status-value">0</span>
			</div>
			<div class="status-item">
				<span class="status-label">é¸æŠ:</span>
				<span id="statusSelected" class="status-value">ãªã—</span>
			</div>
			<div class="status-item" id="statusChordModeItem">
				<span class="status-label">å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰:</span>
				<span id="statusChordMode" class="status-value">OFF</span>
			</div>
			<div class="status-item">
				<span class="status-label">å…¥åŠ›çŠ¶æ…‹:</span>
				<span id="statusPending" class="status-value">é€šå¸¸</span>
			</div>
		</div>

		<!-- ä¸‹æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
		<div class="layout">
			<!-- å·¦ï¼šã‚­ãƒ¼ãƒãƒƒãƒ— -->
			<section class="panel">
				<h2>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆå’ŒéŸ³å¼·åŒ–ç‰ˆï¼‰</h2>
				
				<div class="instruction-highlight">
					<b>ğŸ¹ å’ŒéŸ³ã®å…¥åŠ›æ–¹æ³•ï¼ˆ2ã¤ã®æ–¹æ³•ï¼‰ï¼š</b><br>
					1. <code>Shift+æ•°å­—</code>: ç›´å‰ã®éŸ³ç¬¦ã«å’ŒéŸ³ã¨ã—ã¦è¿½åŠ <br>
					2. <code>H</code>ã‚­ãƒ¼: å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ON/OFFï¼ˆONã®é–“ã¯å…¨ã¦å’ŒéŸ³ï¼‰
				</div>
				
				<p>
					<b>â–  éŸ³ã®æŒ‡å®šï¼š</b><br>
					ãƒ»<code>c d e f g a b</code> â†’ éŸ³åãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°<br>
					ãƒ»ç¶šã‘ã¦ <code>0ã€œ8</code> â†’ å˜éŸ³æŒ¿å…¥/å¤‰æ›´<br>
					ãƒ»ç¶šã‘ã¦ <code>Shift+0ã€œ8</code> â†’ <span class="chord">å’ŒéŸ³ã¨ã—ã¦è¿½åŠ </span><br><br>

					<b>â–  éŸ³ä¾¡/ä¼‘ç¬¦ï¼š</b><br>
					ãƒ»<code>1</code>ã€œ<code>5</code> (å…¨ã€œ16åˆ†) â†’ éŸ³ä¾¡è¨­å®š<br>
					ãƒ»<code>Shift+1ã€œ5</code> â†’ å¯¾å¿œã™ã‚‹ä¼‘ç¬¦ã‚’æŒ¿å…¥<br><br>

					<b>â–  é€£çµãƒ»è£…é£¾ï¼š</b><br>
					ãƒ»<code>T</code> â†’ ã‚¿ã‚¤ ãƒˆã‚°ãƒ«<br>
					ãƒ»<code>S</code> â†’ ã‚¹ãƒ©ãƒ¼ ãƒˆã‚°ãƒ«<br>
					ãƒ»<code>.</code> â†’ ä»˜ç‚¹ãƒˆã‚°ãƒ«<br><br>

					<b>â–  ãã®ä»–ï¼š</b><br>
					ãƒ»<code>H</code> â†’ <span class="chord">å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</span><br>
					ãƒ»<code>N</code> / <code>Space</code> â†’ ç¾åœ¨è¨­å®šã§éŸ³ç¬¦æŒ¿å…¥<br>
					ãƒ»<code>#</code> / <code>b</code> â†’ â™¯ / â™­<br>
					ãƒ»<code>+</code> / <code>-</code> â†’ éŸ³é«˜ã‚’ä¸Šä¸‹<br>
					ãƒ»<code>|</code> â†’ å°ç¯€ç·š<br>
					ãƒ»â† / â†’ â†’ ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠç§»å‹•<br>
					ãƒ»Backspace / Delete â†’ é¸æŠä¸­ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
				</p>
			</section>

			<!-- å³ï¼šã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
			<section class="panel">
				<h2>ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ &amp; MusicXML</h2>
				<ul id="eventList" class="event-list"></ul>
				<div class="btn-row">
					<button id="clearBtn" class="btn-secondary" type="button">å…¨å‰Šé™¤</button>
					<button id="downloadBtn" class="btn-primary" type="button">MusicXML ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
				</div>
			</section>
		</div>
	</div>

<script>
/* ============================
	å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
	============================ */

// C0ã€œB8 ã¾ã§ã®ç™½éµ
const PITCHES = [];
for (let octave = 0; octave <= 8; octave++) {
	for (const step of ["C", "D", "E", "F", "G", "A", "B"]) {
		PITCHES.push({ step, octave });
	}
}

// ã‚ã‚‹ step/octave ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
function pitchIndexFor(step, octave) {
	for (let i = 0; i < PITCHES.length; i++) {
		if (PITCHES[i].step === step && PITCHES[i].octave === octave) return i;
	}
	if (octave < 0) return 0;
	if (octave > 8) return PITCHES.length - 1;
	return 0;
}

function pitchLabel(idx, alter) {
	const base = PITCHES[idx];
	const acc = alter === 1 ? "#" : alter === -1 ? "b" : "";
	return base.step + acc + base.octave;
}

// éŸ³ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«
const DIV = 8; // quarter = 8
const DUR_INFO = {
	whole:	 { xml: "whole",	jp: "å…¨",	div: DIV * 4 },
	half:	 { xml: "half",	 jp: "2åˆ†",	div: DIV * 2 },
	quarter: { xml: "quarter", jp: "4åˆ†",	div: DIV },
	eighth:	 { xml: "eighth",	jp: "8åˆ†",	div: DIV / 2 },
	"16th":	 { xml: "16th",	jp: "16åˆ†", div: DIV / 4 }
};
const DUR_ORDER = ["whole", "half", "quarter", "eighth", "16th"];

/* ============================
	çŠ¶æ…‹
	============================ */

let curPitchIdx = pitchIndexFor("C", 4);
let curDuration = "quarter";
let curAlter = 0;
let curDots = 0;
let chordMode = false; // å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°

/**
 * events: {
 * type: "note" | "rest" | "bar" | "final-bar",
 * duration: string,
 * dots: number,
 * isChord: boolean, // å’ŒéŸ³ã¨ã—ã¦å‰ã®éŸ³ç¬¦ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ¼”å¥ã•ã‚Œã‚‹ã‹ (noteã®ã¿)
 * ties: string[], // "start", "stop" (noteã®ã¿)
 * slurs: string[], // "start", "stop" (noteã®ã¿)
 * restOctave: number // ä¼‘ç¬¦ã®è¡¨ç¤ºä½ç½® (restã®ã¿)
 * }
 */
let events = [];
let selected = -1;
let pendingStep = null;
let pendingOctave = null;
let lastBarKey = false;

// OSMD é–¢é€£
let osmd = null;
let osmdReady = false;
let osmdRenderTimer = null;

// DOM è¦ç´ 
const eventList = document.getElementById("eventList");
const downloadBtn = document.getElementById("downloadBtn");
const clearBtn = document.getElementById("clearBtn");
const statusPitch = document.getElementById("statusPitch");
const statusDuration = document.getElementById("statusDuration");
const statusAccidental = document.getElementById("statusAccidental");
const statusCount = document.getElementById("statusCount");
const statusSelected = document.getElementById("statusSelected");
const statusPending = document.getElementById("statusPending");
const statusChordMode = document.getElementById("statusChordMode");
const statusChordModeItem = document.getElementById("statusChordModeItem");

/* ============================
	ã‚¤ãƒ™ãƒ³ãƒˆæ“ä½œ
	============================ */

// æœ€å¾Œã®éŸ³ç¬¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™
function findLastNoteIndex() {
	for (let i = events.length - 1; i >= 0; i--) {
		if (events[i].type === "note") {
			return i;
		}
	}
	return -1;
}

// ç›´å‰ã®éŸ³ç¬¦ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ã‚‹æœ€åˆã®éŸ³ç¬¦ã‚’æ¢ã™
function findChordBaseIndex() {
	// æœ€å¾Œã®éŸ³ç¬¦ã‚’æ¢ã™
	const lastNoteIdx = findLastNoteIndex();
	if (lastNoteIdx < 0) return -1;
	
	// ãã®éŸ³ç¬¦ãŒå’ŒéŸ³ã®ä¸€éƒ¨ãªã‚‰ã€ã•ã‚‰ã«é¡ã£ã¦å’ŒéŸ³ã®åŸºæº–éŸ³ã‚’æ¢ã™
	let baseIdx = lastNoteIdx;
	while (baseIdx > 0 && events[baseIdx].isChord) {
		baseIdx--;
		// éŸ³ç¬¦ã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
		while (baseIdx >= 0 && events[baseIdx].type !== "note") {
			baseIdx--;
		}
	}
	
	return baseIdx >= 0 && events[baseIdx].type === "note" ? baseIdx : -1;
}

// éŸ³ç¬¦è¿½åŠ ãƒ»ä¿®æ­£
function addNoteOrModifyPitch(step, octave, forceChord = false) {
	const idx = pitchIndexFor(step, octave);
	
	// å’ŒéŸ³ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
	const shouldBeChord = forceChord || chordMode;
	
	if (selected >= 0 && events[selected].type === "note") {
		// é¸æŠä¸­ã®éŸ³ç¬¦ãŒã‚ã‚‹å ´åˆã¯å¤‰æ›´
		events[selected].pitchIdx = idx;
		events[selected].alter = 0;
		setSelected(selected);
	} else {
		// æ–°è¦è¿½åŠ 
		const newNote = {
			type: "note",
			pitchIdx: idx,
			alter: 0,
			duration: curDuration,
			dots: curDots,
			isChord: false,
			ties: [],
			slurs: []
		};
		
		// å’ŒéŸ³ã¨ã—ã¦è¿½åŠ ã™ã‚‹å ´åˆ
		if (shouldBeChord && events.length > 0) {
			const lastNoteIdx = findLastNoteIndex();
			if (lastNoteIdx >= 0) {
				newNote.isChord = true;
				// å’ŒéŸ³ã®åŸºæº–éŸ³ã®éŸ³ä¾¡æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
				const baseNote = events[lastNoteIdx];
				newNote.duration = baseNote.duration;
				newNote.dots = baseNote.dots;
			}
		}
		
		events.push(newNote);
		setSelected(events.length - 1);
	}
	
	curPitchIdx = idx;
	curAlter = 0;
}

function addNoteCurrent() {
	const base = PITCHES[curPitchIdx];
	
	// å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ãŒONã®å ´åˆã¯å’ŒéŸ³ã¨ã—ã¦è¿½åŠ 
	const shouldBeChord = chordMode;
	
	const newNote = {
		type: "note",
		pitchIdx: curPitchIdx,
		alter: curAlter,
		duration: curDuration,
		dots: curDots,
		isChord: false,
		ties: [],
		slurs: []
	};
	
	// å’ŒéŸ³ã¨ã—ã¦è¿½åŠ ã™ã‚‹å ´åˆ
	if (shouldBeChord && events.length > 0) {
		const lastNoteIdx = findLastNoteIndex();
		if (lastNoteIdx >= 0) {
			newNote.isChord = true;
			// å’ŒéŸ³ã®åŸºæº–éŸ³ã®éŸ³ä¾¡æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
			const baseNote = events[lastNoteIdx];
			newNote.duration = baseNote.duration;
			newNote.dots = baseNote.dots;
		}
	}
	
	events.push(newNote);
	setSelected(events.length - 1);
}

function addRest(duration) {
	const restOctave = PITCHES[curPitchIdx].octave;
	events.push({
		type: "rest",
		duration: duration || curDuration,
		dots: curDots,
		restOctave: restOctave
	});
	setSelected(events.length - 1);
}

function addBar(isFinal) {
	events.push({ type: isFinal ? "final-bar" : "bar" });
	setSelected(events.length - 1);
}

function setSelected(idx) {
	selected = idx;
	if (idx >= 0 && events[idx].type === "note") {
		curPitchIdx = events[idx].pitchIdx;
		curDuration = events[idx].duration;
		curAlter = events[idx].alter;
		curDots = events[idx].dots;
	} else if (idx >= 0 && events[idx].type === "rest") {
		curDuration = events[idx].duration;
		curDots = events[idx].dots;
	}
	renderEventList();
	updateStatus();
	scheduleOSMDRerender();
}

function deleteSelected() {
	if (selected < 0 || selected >= events.length) return;
	events.splice(selected, 1);
	if (selected >= events.length) selected = events.length - 1;
	renderEventList();
	updateStatus();
	scheduleOSMDRerender();
}

function setDurationByDigit(n) {
	const dur = DUR_ORDER[n - 1];
	if (dur) {
		curDuration = dur;
		if (selected >= 0 && (events[selected].type === "note" || events[selected].type === "rest")) {
			events[selected].duration = dur;
			setSelected(selected);
		}
	}
}

function setAccidental(type) {
	const val = type === "sharp" ? 1 : type === "flat" ? -1 : 0;
	curAlter = val;
	if (selected >= 0 && events[selected].type === "note") {
		events[selected].alter = val;
		setSelected(selected);
	}
}

function toggleDot() {
	curDots = curDots > 0 ? 0 : 1;
	if (selected >= 0 && (events[selected].type === "note" || events[selected].type === "rest")) {
		events[selected].dots = curDots;
		setSelected(selected);
	}
}

function movePitch(delta) {
	if (selected >= 0 && events[selected].type === "note") {
		const newIdx = Math.max(0, Math.min(PITCHES.length - 1, events[selected].pitchIdx + delta));
		events[selected].pitchIdx = newIdx;
		setSelected(selected);
	}
}

function toggleConnection(field) {
	// "ties" ã¾ãŸã¯ "slurs"
	if (selected < 0 || events[selected].type !== "note") return;
	const note = events[selected];
	
	if (note[field].includes("start")) {
		// æ—¢ã« start ãŒã‚ã‚‹å ´åˆã€stop ã«åˆ‡ã‚Šæ›¿ãˆ
		note[field] = ["stop"];
	} else if (note[field].includes("stop")) {
		// stop ãŒã‚ã‚‹å ´åˆã€ã‚¯ãƒªã‚¢
		note[field] = [];
	} else {
		// ä½•ã‚‚ãªã„å ´åˆã€start ã‚’è¨­å®š
		note[field] = ["start"];
	}
	setSelected(selected);
}

// å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleChordMode() {
	chordMode = !chordMode;
	updateStatus();
}

/* ============================
	è¡¨ç¤ºæ›´æ–°
	============================ */

function renderEventList() {
	eventList.innerHTML = "";
	events.forEach((ev, i) => {
		const li = document.createElement("li");
		li.className = "event-item";
		if (i === selected) li.classList.add("selected");
		if (ev.type === "note" && ev.isChord) li.classList.add("chord");
		
		const indexSpan = document.createElement("span");
		indexSpan.className = "event-index";
		indexSpan.textContent = `[${i + 1}]`;
		li.appendChild(indexSpan);
		
		const contentSpan = document.createElement("span");
		if (ev.type === "note") {
			const label = pitchLabel(ev.pitchIdx, ev.alter);
			const durLabel = DUR_INFO[ev.duration].jp;
			const dots = ev.dots > 0 ? "." : "";
			const chordIndicator = ev.isChord ? " [å’ŒéŸ³]" : "";
			const tieLabel = ev.ties.length > 0 ? ` tie:${ev.ties.join(",")}` : "";
			const slurLabel = ev.slurs.length > 0 ? ` slur:${ev.slurs.join(",")}` : "";
			contentSpan.innerHTML = `<b>${label}</b> ${durLabel}${dots}${chordIndicator}${tieLabel}${slurLabel}`;
			if (ev.isChord) {
				const chordSpan = document.createElement("span");
				chordSpan.className = "chord-indicator";
				chordSpan.textContent = "â™ª";
				contentSpan.appendChild(chordSpan);
			}
		} else if (ev.type === "rest") {
			const durLabel = DUR_INFO[ev.duration].jp;
			const dots = ev.dots > 0 ? "." : "";
			contentSpan.textContent = `ä¼‘ç¬¦ ${durLabel}${dots}`;
		} else if (ev.type === "bar") {
			contentSpan.textContent = "å°ç¯€ç·š";
		} else if (ev.type === "final-bar") {
			contentSpan.textContent = "çµ‚æ­¢ç·š";
		}
		li.appendChild(contentSpan);
		
		li.addEventListener("click", () => setSelected(i));
		eventList.appendChild(li);
	});
}

function updateStatus() {
	statusPitch.textContent = pitchLabel(curPitchIdx, curAlter);
	statusDuration.textContent = DUR_INFO[curDuration].jp + (curDots > 0 ? "." : "");
	statusAccidental.textContent = curAlter === 1 ? "â™¯" : curAlter === -1 ? "â™­" : "ãªã—";
	statusCount.textContent = events.length;
	
	if (selected >= 0) {
		const ev = events[selected];
		if (ev.type === "note") {
			const label = pitchLabel(ev.pitchIdx, ev.alter);
			const chordIndicator = ev.isChord ? " [å’ŒéŸ³]" : "";
			statusSelected.innerHTML = `<span class="${ev.isChord ? 'chord' : ''}">${label}${chordIndicator}</span>`;
		} else {
			statusSelected.textContent = `[${selected + 1}] ${ev.type}`;
		}
	} else {
		statusSelected.textContent = "ãªã—";
	}
	
	// å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	statusChordMode.textContent = chordMode ? "ON" : "OFF";
	statusChordMode.className = chordMode ? "status-value chord" : "status-value";
	statusChordModeItem.className = chordMode ? "status-item chord-mode" : "status-item";
	
	// ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
	if (pendingStep) {
		statusPending.innerHTML = `<span class="pending">${pendingStep.toUpperCase()}...</span>`;
	} else {
		statusPending.textContent = chordMode ? "å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰" : "é€šå¸¸";
		if (chordMode) {
			statusPending.className = "status-value chord";
		} else {
			statusPending.className = "status-value";
		}
	}
}

/* ============================
	ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
	============================ */

document.addEventListener("keydown", (e) => {
	const key = e.key.toLowerCase();
	let updateRequired = true;
	
	// éŸ³åå…¥åŠ› c d e f g a b
	if ("cdefgab".includes(key) && key.length === 1) {
		e.preventDefault();
		pendingStep = key.toUpperCase();
		pendingOctave = null;
		updateStatus(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘æ›´æ–°
		return;
	}
	// å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
	else if (key === "h") {
		e.preventDefault();
		toggleChordMode();
		return;
	}
	// æ•°å­—ã‚­ãƒ¼å‡¦ç†
	else if (key >= "0" && key <= "9") {
		// ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®éŸ³åãŒã‚ã‚‹å ´åˆ
		if (pendingStep) {
			e.preventDefault();
			const octave = parseInt(key, 10);
			
			// Shiftã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã¾ãŸã¯å’ŒéŸ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å’ŒéŸ³ã¨ã—ã¦è¿½åŠ 
			const isChord = e.shiftKey || chordMode;
			
			addNoteOrModifyPitch(pendingStep, octave, isChord);
			pendingStep = null;
			pendingOctave = null;
			// addNoteOrModifyPitchå†…ã§ render & updateStatus ã—ã¦ã„ã‚‹ã®ã§ return
			return;
		} else {
			pendingStep = null;
			pendingOctave = null;
		}

		// é€šå¸¸ãƒ•ã‚§ãƒ¼ã‚º â†’ éŸ³ä¾¡/ä¼‘ç¬¦
		const n = parseInt(key, 10);
		if (n >= 1 && n <= 5) {
			e.preventDefault();
			if (e.shiftKey) {
				addRest(DUR_ORDER[n - 1]);
			} else {
				setDurationByDigit(n);
			}
		} else {
			updateRequired = false;
		}
	}
	// N / Space â†’ ç¾åœ¨è¨­å®šã§éŸ³ç¬¦æŒ¿å…¥
	else if (key === " " || key === "n") {
		e.preventDefault();
		addNoteCurrent();
	}
	// ã‚¿ã‚¤ãƒ»ã‚¹ãƒ©ãƒ¼
	else if (key === "t") {
		e.preventDefault();
		toggleConnection("ties");
	}
	else if (key === "s") {
		e.preventDefault();
		toggleConnection("slurs");
	}
	// éŸ³é«˜å¤‰æ›´
	else if (key === "+") {
		e.preventDefault();
		movePitch(+1);
	}
	else if (key === "-") {
		e.preventDefault();
		movePitch(-1);
	}
	// å°ç¯€ç·š | / ||
	else if (key === "|") {
		e.preventDefault();
		if (lastBarKey) {
			lastBarKey = false;
			if (events.length > 0 && events[events.length - 1].type === "bar") {
				events[events.length - 1].type = "final-bar";
				setSelected(events.length - 1);
			} else {
				addBar(true);
			}
		} else {
			addBar(false);
			lastBarKey = true;
		}
	}
	// è‡¨æ™‚è¨˜å·
	else if (key === "#") {
		e.preventDefault();
		setAccidental("sharp");
	}
	else if (key === "b") {
		e.preventDefault();
		setAccidental("flat");
	}
	// ä»˜ç‚¹
	else if (key === ".") {
		e.preventDefault();
		toggleDot();
	}
	// ç§»å‹•
	else if (key === "arrowleft") {
		e.preventDefault();
		if (selected > 0) setSelected(selected - 1);
		updateRequired = false; // setSelectedãŒrenderã‚’å‘¼ã¶ãŸã‚
	}
	else if (key === "arrowright") {
		e.preventDefault();
		if (selected < events.length - 1) setSelected(selected + 1);
		updateRequired = false;
	}
	// å‰Šé™¤
	else if (key === "backspace" || key === "delete") {
		e.preventDefault();
		deleteSelected();
	} else {
		updateRequired = false;
	}

	// ã“ã“ã¾ã§æ¥ãŸã‚‰ pending ã¯è§£é™¤
	pendingStep = null;
	pendingOctave = null;

	if (updateRequired) {
		renderEventList();
		updateStatus();
		scheduleOSMDRerender();
	} else {
		updateStatus();
	}
});

/* ============================
	MusicXML ç”Ÿæˆ
	============================ */

function generateMusicXML() {
	let xml = `<?xml version="1.0" encoding="UTF-8"?>
<score-partwise version="3.1">
	<part-list>
		<score-part id="P1">
			<part-name>Keyboard Editor</part-name>
		</score-part>
	</part-list>
	<part id="P1">
`;

	let measureNumber = 1;
	let open = false;

	function openMeasure() {
		xml += `	<measure number="${measureNumber}">
`;
		if (measureNumber === 1) {
			// åˆæœŸè¨­å®š (4/4æ‹å­ã€ãƒé•·èª¿ã€ãƒˆéŸ³è¨˜å·)
			xml += `	<attributes>
			<divisions>${DIV}</divisions>
			<key><fifths>0</fifths></key>
			<time><beats>4</beats><beat-type>4</beat-type></time>
			<clef><sign>G</sign><line>2</line></clef>
		</attributes>
`;
		}
		open = true;
	}

	function closeMeasure(isFinal) {
		if (isFinal) {
			xml += `	<barline location="right">
			<bar-style>light-heavy</bar-style>
		</barline>
`;
		}
		xml += `	</measure>
`;
		open = false;
		measureNumber++;
	}

	// ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯å…¨ä¼‘ç¬¦1å°ç¯€ã‚’æŒ¿å…¥
	if (events.length === 0) {
		openMeasure();
		const d = DUR_INFO.whole;
		xml += `	<note>
		<rest/>
		<duration>${d.div}</duration>
		<type>${d.xml}</type>
	</note>
`;
		closeMeasure(false);
	} else {
		openMeasure();
		events.forEach((ev, i) => {
			if (ev.type === "note") {
				const base = PITCHES[ev.pitchIdx];
				const info = DUR_INFO[ev.duration];
				let dur = info.div;
				if (ev.dots) dur += info.div / 2;

				xml += `	<note>
`;
				// å’ŒéŸ³ã®å ´åˆã¯chordã‚¿ã‚°ã‚’è¿½åŠ 
				if (ev.isChord) {
					xml += `		<chord/>
`;
				}
				xml += `		<pitch>
			<step>${base.step}</step>
`;
				if (ev.alter) {
					xml += `			<alter>${ev.alter}</alter>
`;
				}
				xml += `			<octave>${base.octave}</octave>
		</pitch>
		<duration>${dur}</duration>
		<type>${info.xml}</type>
`;
				if (ev.dots) {
					xml += `		<dot/>
`;
				}
				if (ev.alter !== 0) {
					xml += `		<accidental>${ev.alter === 1 ? 'sharp' : 'flat'}</accidental>
`;
				}

				// ã‚¿ã‚¤ãƒ»ã‚¹ãƒ©ãƒ¼
				if (ev.ties.length > 0 || ev.slurs.length > 0) {
					xml += `		<notations>
`;
					ev.ties.forEach(t => {
						xml += `			<tied type="${t}"/>
`;
					});
					ev.slurs.forEach(s => {
						xml += `			<slur type="${s}" number="1"/>
`;
					});
					xml += `		</notations>
`;
				}
				
				// MusicXML 3.1 ã§ã¯ <tie> ã‚¿ã‚°ã¯ <note> ã®ç›´ä¸‹ã«é…ç½®
				ev.ties.forEach(t => {
					xml += `		<tie type="${t}"/>
`;
				});
				
				xml += `	</note>
`;
			} else if (ev.type === "rest") {
				const info = DUR_INFO[ev.duration];
				let dur = info.div;
				if (ev.dots) dur += info.div / 2;

				xml += `	<note>
		<rest>
`;
				// ä¼‘ç¬¦ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æŒ‡å®šï¼ˆè¡¨ç¤ºä½ç½®èª¿æ•´ã®ãŸã‚ï¼‰
				const restPitch = PITCHES[pitchIndexFor("B", ev.restOctave)];
				xml += `			<display-step>${restPitch.step}</display-step>
			<display-octave>${restPitch.octave}</display-octave>
`;
				xml += `		</rest>
		<duration>${dur}</duration>
		<type>${info.xml}</type>
`;
				if (ev.dots) {
					xml += `		<dot/>
`;
				}
				xml += `	</note>
`;
			} else if (ev.type === "bar" || ev.type === "final-bar") {
				const isFinal = ev.type === "final-bar";
				closeMeasure(isFinal);
				if (!(isFinal && i === events.length - 1)) {
					openMeasure();
				}
			}
		});
		if (open) closeMeasure(false);
	}

	xml += `	</part>
</score-partwise>
`;
	return xml;
}

/* ============================
	OSMD åˆæœŸåŒ–ï¼†å†æç”»
	============================ */

async function initOSMD() {
	osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmd-container", {
		autoResize: true,
		drawTitle: false,
		followCursor: false,
		disableCursor: true,
		drawingParameters: "compact",
	});
	osmdReady = true;
	// åˆæœŸã®ç©ºè­œ
	const xml = generateMusicXML();
	try {
		await osmd.load(xml);
		osmd.render();
		document.getElementById("osmd-container").textContent = "";
	} catch (err) {
		document.getElementById("osmd-container").textContent = "æ¥½è­œã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
		console.error("OSMD init error:", err);
	}
}

function scheduleOSMDRerender() {
	if (!osmdReady) return;
	if (osmdRenderTimer) clearTimeout(osmdRenderTimer);
	osmdRenderTimer = setTimeout(async () => {
		const xml = generateMusicXML();
		try {
			await osmd.load(xml);
			osmd.render();
		} catch (err) {
			console.error("OSMD render error:", err);
		}
	}, 250);
}

/* ============================
	ãƒœã‚¿ãƒ³å‡¦ç†
	============================ */

downloadBtn.addEventListener("click", () => {
	const xml = generateMusicXML();
	const blob = new Blob([xml], { type: "application/vnd.recordare.musicxml+xml" });
	const url = URL.createObjectURL(blob);
	const a = document.createElement("a");
	a.href = url;
	a.download = "score.musicxml";
	document.body.appendChild(a);
	a.click();
	document.body.removeChild(a);
	URL.revokeObjectURL(url);
});

clearBtn.addEventListener("click", () => {
	if (confirm("å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
		events = [];
		selected = -1;
		pendingStep = null;
		pendingOctave = null;
		chordMode = false;
		renderEventList();
		updateStatus();
		scheduleOSMDRerender();
	}
});

/* ============================
	åˆæœŸåŒ–
	============================ */

renderEventList();
updateStatus();
window.onload = initOSMD;

</script>
</body>
</html>
