<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSON æ¥½è­œã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒˆéŸ³è¨˜å·ãƒ»ãƒ˜éŸ³è¨˜å·å¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    header {
      padding: 10px 16px;
      background: #333;
      color: #fff;
      font-size: 16px;
    }

    main {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
    }

    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .left-panel {
      flex: 1 1 260px;
      min-width: 260px;
    }

    .right-panel {
      flex: 2 1 320px;
      min-width: 320px;
    }

    .field-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    label {
      font-size: 12px;
      margin-right: 4px;
    }

    input[type="number"],
    select {
      padding: 4px 6px;
      font-size: 14px;
    }

    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.secondary {
      background: #666;
    }

    button.danger {
      background: #c62828;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    canvas {
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #ddd;
      width: 100%;
      height: auto;
      max-width: 100%;
    }

    .notes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    .notes-table th,
    .notes-table td {
      border-bottom: 1px solid #eee;
      padding: 4px 6px;
      text-align: left;
    }

    .notes-table th {
      background: #fafafa;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      font-family: monospace;
      font-size: 12px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .small {
      font-size: 11px;
      opacity: 0.8;
    }

    .clef-info {
      padding: 8px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 12px;
      margin: 8px 0;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<header>
  JSON æ¥½è­œã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒˆéŸ³è¨˜å·ãƒ»ãƒ˜éŸ³è¨˜å·å¯¾å¿œï¼‰ â€“ Multi-clef Score Editor
</header>

<main>
  <!-- å·¦ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  & ãƒãƒ¼ãƒˆä¸€è¦§ -->
  <section class="panel left-panel">
    <h2 style="margin-top:0;font-size:16px;">æ¥½è­œè¨­å®š / Score Settings</h2>

    <div class="field-group">
      <label for="clef">éŸ³éƒ¨è¨˜å· / Clef:</label>
      <select id="clef">
        <option value="treble">ãƒˆéŸ³è¨˜å· (Treble)</option>
        <option value="bass">ãƒ˜éŸ³è¨˜å· (Bass)</option>
      </select>
    </div>

    <div class="clef-info" id="clefInfo">
      ãƒˆéŸ³è¨˜å·: é«˜éŸ³åŸŸç”¨ï¼ˆãƒ•ãƒ«ãƒ¼ãƒˆã€ãƒã‚¤ã‚ªãƒªãƒ³ãªã©ï¼‰
    </div>

    <div class="field-group">
      <label for="tempo">ãƒ†ãƒ³ãƒ (BPM):</label>
      <input type="number" id="tempo" value="120" min="30" max="240">
    </div>

    <div class="field-group">
      <label for="timeSig">æ‹å­ / Time Signature:</label>
      <select id="timeSig">
        <option value="4/4">4/4</option>
        <option value="3/4">3/4</option>
        <option value="2/4">2/4</option>
        <option value="6/8">6/8</option>
      </select>
    </div>

    <hr>

    <h3 style="margin-top:8px;font-size:14px;">éŸ³ç¬¦è¿½åŠ  / Add Note</h3>

    <div class="field-group">
      <div>
        <label for="pitch">éŸ³é«˜ / Pitch:</label><br>
        <select id="pitch">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </select>
      </div>

      <div>
        <label for="duration">é•·ã• / Duration:</label><br>
        <select id="duration">
          <option value="whole">å…¨éŸ³ç¬¦ / whole</option>
          <option value="half">2åˆ†éŸ³ç¬¦ / half</option>
          <option value="quarter" selected>4åˆ†éŸ³ç¬¦ / quarter</option>
          <option value="eighth">8åˆ†éŸ³ç¬¦ / eighth</option>
          <option value="sixteenth">16åˆ†éŸ³ç¬¦ / sixteenth</option>
        </select>
      </div>

      <div style="align-self:flex-end;">
        <button id="addNoteBtn">ï¼‹ è¿½åŠ  / Add</button>
      </div>
    </div>

    <p class="small">
      â€» ä¼‘ç¬¦ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ "REST" ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    </p>

    <table class="notes-table" id="notesTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Pitch</th>
          <th>Duration</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <!-- JS ã§æŒ¿å…¥ -->
      </tbody>
    </table>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="secondary" id="clearNotesBtn">å…¨å‰Šé™¤ / Clear all</button>
    </div>

    <!-- JSON ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <div class="field-group" style="margin-top:12px;">
      <input type="file" id="jsonFileInput" accept="application/json" style="display:none;">
      <button id="loadJsonBtn" class="secondary">JSONã‚’èª­ã¿è¾¼ã‚€ / Load JSON</button>
    </div>
  </section>

  <!-- å³ï¼šäº”ç·šè­œ & JSON -->
  <section class="panel right-panel">
    <h2 style="margin-top:0;font-size:16px;">äº”ç·šè­œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / Staff Preview</h2>
    <canvas id="staffCanvas" width="800" height="200"></canvas>

    <h3 style="margin-top:12px;font-size:14px;">JSON æ¥½è­œ / JSON Score</h3>
    <textarea id="jsonOutput" readonly></textarea>
    <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="copyJsonBtn">JSON ã‚’ã‚³ãƒ”ãƒ¼ / Copy JSON</button>
      <button id="downloadJsonBtn" class="secondary">JSON ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / Download</button>
    </div>
    <p class="small">
      éŸ³éƒ¨è¨˜å·ï¼ˆclefï¼‰æƒ…å ±ã‚‚ JSON ã«å«ã¾ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªå´ã§é©åˆ‡ãªéŸ³åŸŸã§å†ç”Ÿã—ã¦ãã ã•ã„ã€‚
    </p>
  </section>
</main>

<script>
  // å†…éƒ¨çŠ¶æ…‹
  let notes = [];
  let currentClef = 'treble';

  const clefSelect       = document.getElementById('clef');
  const clefInfo         = document.getElementById('clefInfo');
  const tempoInput       = document.getElementById('tempo');
  const timeSigSelect    = document.getElementById('timeSig');
  const pitchSelect      = document.getElementById('pitch');
  const durationSelect   = document.getElementById('duration');
  const addNoteBtn       = document.getElementById('addNoteBtn');
  const clearNotesBtn    = document.getElementById('clearNotesBtn');
  const notesTableBody   = document.querySelector('#notesTable tbody');
  const jsonOutput       = document.getElementById('jsonOutput');
  const copyJsonBtn      = document.getElementById('copyJsonBtn');
  const downloadJsonBtn  = document.getElementById('downloadJsonBtn');
  const canvas           = document.getElementById('staffCanvas');
  const ctx              = canvas.getContext('2d');

  // JSONèª­ã¿è¾¼ã¿ç”¨
  const jsonFileInput    = document.getElementById("jsonFileInput");
  const loadJsonBtn      = document.getElementById("loadJsonBtn");

  // ãƒˆéŸ³è¨˜å·ã§ã®éŸ³ç¬¦ä½ç½®
  const trebleNotePositions = {
    "C6": 5.5,
    "B5": 5,
    "A5": 4.5,
    "G5": 4,
    "F5": 3.5,
    "E5": 3,
    "D5": 2.5,
    "C5": 2,
    "B4": 1.5,
    "A4": 1,
    "G4": 0.5,
    "F4": 0,
    "E4": -0.5,
    "D4": -1,
    "C4": -1.5,
    "B3": -2,
    "A3": -2.5,
    "REST": null  // ä¼‘ç¬¦
  };

  // ãƒ˜éŸ³è¨˜å·ã§ã®éŸ³ç¬¦ä½ç½®ï¼ˆF3ãŒç¬¬4ç·šï¼‰
  const bassNotePositions = {
    "E4": 5.5,
    "D4": 5,
    "C4": 4.5,
    "B3": 4,
    "A3": 3.5,
    "G3": 3,
    "F3": 2.5,   // ç¬¬4ç·š
    "E3": 2,
    "D3": 1.5,
    "C3": 1,
    "B2": 0.5,
    "A2": 0,
    "G2": -0.5,
    "F2": -1,
    "E2": -1.5,
    "D2": -2,
    "C2": -2.5,
    "REST": null  // ä¼‘ç¬¦
  };

  // éŸ³åŸŸãƒªã‚¹ãƒˆ
  const trebleNotes = ["C6","B5","A5","G5","F5","E5","D5","C5","B4","A4","G4","F4","E4","D4","C4","B3","A3","REST"];
  const bassNotes = ["E4","D4","C4","B3","A3","G3","F3","E3","D3","C3","B2","A2","G2","F2","E2","D2","C2","REST"];

  // æ®µçµ„ã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±
  let scoreLayout = {
    barsCount: 1,
    linesCount: 1,
    barCapacity: 4,
    barsPerLine: 4,
    lineHeight: 180
  };

  // éŸ³éƒ¨è¨˜å·å¤‰æ›´æ™‚ã®å‡¦ç†
  function updateClef() {
    currentClef = clefSelect.value;
    
    // æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
    if (currentClef === 'treble') {
      clefInfo.textContent = 'ãƒˆéŸ³è¨˜å·: é«˜éŸ³åŸŸç”¨ï¼ˆãƒ•ãƒ«ãƒ¼ãƒˆã€ãƒã‚¤ã‚ªãƒªãƒ³ã€ãƒ”ã‚¢ãƒå³æ‰‹ãªã©ï¼‰';
      clefInfo.style.background = '#e3f2fd';
    } else {
      clefInfo.textContent = 'ãƒ˜éŸ³è¨˜å·: ä½éŸ³åŸŸç”¨ï¼ˆãƒã‚§ãƒ­ã€ãƒ•ã‚¡ã‚´ãƒƒãƒˆã€ãƒ”ã‚¢ãƒå·¦æ‰‹ãªã©ï¼‰';
      clefInfo.style.background = '#fce4ec';
    }
    
    // éŸ³é«˜é¸æŠã‚’æ›´æ–°
    updatePitchOptions();
    
    // å†æç”»
    syncAll();
  }

  // éŸ³é«˜é¸æŠè‚¢ã‚’æ›´æ–°
  function updatePitchOptions() {
    const noteList = currentClef === 'treble' ? trebleNotes : bassNotes;
    pitchSelect.innerHTML = '';
    
    noteList.forEach(note => {
      const option = document.createElement('option');
      option.value = note;
      if (note === 'REST') {
        option.textContent = 'ä¼‘ç¬¦ / Rest';
      } else {
        option.textContent = note;
      }
      pitchSelect.appendChild(option);
    });
  }

  // duration â†’ 4åˆ†éŸ³ç¬¦å˜ä½
  function durationToUnits(d) {
    switch (d) {
      case "whole":     return 4;     // å…¨éŸ³ç¬¦
      case "half":      return 2;     // 2åˆ†éŸ³ç¬¦
      case "quarter":   return 1;     // 4åˆ†éŸ³ç¬¦
      case "eighth":    return 0.5;   // 8åˆ†éŸ³ç¬¦
      case "sixteenth": return 0.25;  // 16åˆ†éŸ³ç¬¦
      default:          return 1;
    }
  }

  // æ‹å­ã‹ã‚‰1å°ç¯€ã‚ãŸã‚Šã® 4åˆ†éŸ³ç¬¦å˜ä½ã‚’è¨ˆç®—
  function computeBarCapacity() {
    const ts = timeSigSelect.value || "4/4";
    const parts = ts.split("/");
    const num = parseInt(parts[0], 10);
    const den = parseInt(parts[1], 10);
    if (!num || !den) return 4;
    return num * (4 / den);
  }

  // éŸ³ç¬¦ã”ã¨ã«ã€Œå°ç¯€ã€ã€Œå°ç¯€å†…ä½ç½®ã€ã‚’å‰²ã‚ŠæŒ¯ã‚Š
  function computeLayout() {
    const barCapacity = computeBarCapacity();
    const barsPerLine = 4;
    const lineHeight  = 180;

    let barIndex   = 0;
    let barPosUnit = 0;
    let barsCount  = 1;

    notes.forEach(note => {
      const u = durationToUnits(note.duration);
      if (barPosUnit + u > barCapacity + 1e-6) {
        barIndex++;
        barPosUnit = 0;
      }
      note._barIndex      = barIndex;
      note._posInBarUnits = barPosUnit;
      barPosUnit += u;
      barsCount = Math.max(barsCount, barIndex + 1);
    });

    if (notes.length === 0) {
      barsCount = 1;
    }

    const linesCount = Math.max(1, Math.ceil(barsCount / barsPerLine));

    scoreLayout = {
      barsCount,
      linesCount,
      barCapacity,
      barsPerLine,
      lineHeight
    };
  }

  function drawStaff() {
    const { linesCount, lineHeight, barsCount, barsPerLine } = scoreLayout;
    const newHeight = Math.max(200, linesCount * lineHeight);
    if (canvas.height !== newHeight) {
      canvas.height = newHeight;
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // èƒŒæ™¯
    ctx.fillStyle = "#fafafa";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const leftMargin   = 60;
    const rightMargin  = canvas.width - 20;
    const usableWidth  = rightMargin - leftMargin;
    const barWidth     = usableWidth / barsPerLine;
    const staffTopBase = 40;
    const lineGap      = 10;

    // å„æ®µã®äº”ç·š
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 1;

    for (let line = 0; line < linesCount; line++) {
      const lineOffsetY = line * lineHeight;
      const staffTop = staffTopBase + lineOffsetY;

      // äº”ç·š 5æœ¬
      for (let i = 0; i < 5; i++) {
        const y = staffTop + i * lineGap;
        ctx.beginPath();
        ctx.moveTo(leftMargin - 20, y);
        ctx.lineTo(rightMargin, y);
        ctx.stroke();
      }

      // éŸ³éƒ¨è¨˜å·ã®æç”»
      ctx.save();
      ctx.font = "32px serif";
      ctx.fillStyle = "#333";
      
      if (currentClef === 'treble') {
        // ãƒˆéŸ³è¨˜å·é¢¨ã®ãƒãƒ¼ã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        ctx.font = "36px serif";
        ctx.fillText("ğ„", leftMargin - 35, staffTop + lineGap * 3);
      } else {
        // ãƒ˜éŸ³è¨˜å·é¢¨ã®ãƒãƒ¼ã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        ctx.font = "32px serif";
        ctx.fillText("ğ„¢", leftMargin - 35, staffTop + lineGap * 1.5);
        // Fç·šã®ç›®å°ï¼ˆ2ã¤ã®ç‚¹ï¼‰
        ctx.fillStyle = "#333";
        ctx.beginPath();
        ctx.arc(leftMargin - 10, staffTop + lineGap * 1, 2, 0, Math.PI * 2);
        ctx.arc(leftMargin - 10, staffTop + lineGap * 2, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();
    }

    // å°ç¯€ç·š
    ctx.strokeStyle = "#bbb";
    ctx.lineWidth = 1;

    for (let b = 1; b < barsCount; b++) {
      const lineIndex  = Math.floor(b / barsPerLine);
      const barInLine  = b % barsPerLine;
      const lineOffsetY = lineIndex * lineHeight;
      const staffTop   = staffTopBase + lineOffsetY;
      const x          = leftMargin + barInLine * barWidth;

      ctx.beginPath();
      ctx.moveTo(x, staffTop - 10);
      ctx.lineTo(x, staffTop + lineGap * 4 + 10);
      ctx.stroke();
    }

    // æœ€å¾Œã®å°ç¯€ç·š
    const lastLineIndex   = Math.floor((barsCount - 1) / barsPerLine);
    const lastLineOffsetY = lastLineIndex * lineHeight;
    const lastStaffTop    = staffTopBase + lastLineOffsetY;

    ctx.strokeStyle = "#666";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(rightMargin, lastStaffTop - 10);
    ctx.lineTo(rightMargin, lastStaffTop + lineGap * 4 + 10);
    ctx.stroke();

    // éŸ³ç¬¦ã®æç”»
    drawNotes();
  }

  function drawNotes() {
    const { barCapacity, barsPerLine, lineHeight } = scoreLayout;
    const notePositions = currentClef === 'treble' ? trebleNotePositions : bassNotePositions;

    const leftMargin   = 60;
    const rightMargin  = canvas.width - 20;
    const usableWidth  = rightMargin - leftMargin;
    const barWidth     = usableWidth / barsPerLine;
    const staffTopBase = 40;
    const lineGap      = 10;

    ctx.fillStyle   = "#000";
    ctx.strokeStyle = "#000";
    ctx.lineWidth   = 1;

    notes.forEach((note) => {
      const pitch   = note.pitch;
      const barIdx  = note._barIndex || 0;
      const posUnit = note._posInBarUnits || 0;
      const position = notePositions[pitch];

      if (position === undefined) return;

      const lineIndex   = Math.floor(barIdx / barsPerLine);
      const barInLine   = barIdx % barsPerLine;
      const lineOffsetY = lineIndex * lineHeight;
      const staffTop    = staffTopBase + lineOffsetY;

      let frac = barCapacity > 0 ? posUnit / barCapacity : 0;
      if (frac < 0) frac = 0;
      if (frac > 1) frac = 1;

      const innerFrac = 0.1 + frac * 0.8;
      const xBarStart = leftMargin + barInLine * barWidth;
      const x         = xBarStart + innerFrac * barWidth;

      // ä¼‘ç¬¦ã®å‡¦ç†
      if (pitch === 'REST') {
        const centerY = staffTop + 2 * lineGap;
        ctx.save();
        ctx.font = "24px serif";
        ctx.fillStyle = "#333";
        
        // ä¼‘ç¬¦è¨˜å·ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        switch(note.duration) {
          case 'whole':
            ctx.fillRect(x - 6, centerY - 4, 12, 6);
            break;
          case 'half':
            ctx.fillRect(x - 6, centerY - 2, 12, 4);
            break;
          case 'quarter':
            ctx.font = "28px serif";
            ctx.fillText("ğ„½", x - 8, centerY + 6);
            break;
          case 'eighth':
            ctx.font = "24px serif";
            ctx.fillText("ğ„¾", x - 6, centerY + 4);
            break;
          case 'sixteenth':
            ctx.font = "24px serif";
            ctx.fillText("ğ„¿", x - 6, centerY + 4);
            break;
        }
        ctx.restore();
        return;
      }

      // é€šå¸¸ã®éŸ³ç¬¦å‡¦ç†
      const firstLineY = staffTop + 4 * lineGap;
      const y = firstLineY - position * lineGap;

      // è£œåŠ©ç·šã®æç”»
      ctx.save();
      ctx.strokeStyle = "#888";
      ctx.lineWidth = 1;
      
      if (position < 0) {
        for (let i = 0; i > position; i -= 1) {
          const ledgerY = firstLineY - i * lineGap;
          ctx.beginPath();
          ctx.moveTo(x - 10, ledgerY);
          ctx.lineTo(x + 10, ledgerY);
          ctx.stroke();
        }
      }
      
      if (position > 4) {
        for (let i = 5; i <= position; i += 1) {
          const ledgerY = firstLineY - i * lineGap;
          ctx.beginPath();
          ctx.moveTo(x - 10, ledgerY);
          ctx.lineTo(x + 10, ledgerY);
          ctx.stroke();
        }
      }
      
      ctx.restore();

      // éŸ³ç¬¦ãƒ˜ãƒƒãƒ‰
      ctx.beginPath();
      ctx.ellipse(x, y, 6, 4, 0, 0, Math.PI * 2);
      
      if (note.duration === "whole" || note.duration === "half") {
        ctx.stroke();
      } else {
        ctx.fill();
      }

      // ã‚¹ãƒ†ãƒ 
      if (note.duration !== "whole") {
        const stemUp = position < 2;
        
        ctx.beginPath();
        if (stemUp) {
          ctx.moveTo(x + 6, y);
          ctx.lineTo(x + 6, y - 30);
        } else {
          ctx.moveTo(x - 6, y);
          ctx.lineTo(x - 6, y + 30);
        }
        ctx.stroke();

        // ãƒ•ãƒ©ãƒƒã‚°
        if (note.duration === "eighth" || note.duration === "sixteenth") {
          ctx.beginPath();
          if (stemUp) {
            ctx.moveTo(x + 6, y - 30);
            ctx.quadraticCurveTo(x + 16, y - 28, x + 10, y - 18);
          } else {
            ctx.moveTo(x - 6, y + 30);
            ctx.quadraticCurveTo(x - 16, y + 28, x - 10, y + 18);
          }
          ctx.stroke();
        }
        if (note.duration === "sixteenth") {
          ctx.beginPath();
          if (stemUp) {
            ctx.moveTo(x + 6, y - 25);
            ctx.quadraticCurveTo(x + 16, y - 23, x + 10, y - 13);
          } else {
            ctx.moveTo(x - 6, y + 25);
            ctx.quadraticCurveTo(x - 16, y + 23, x - 10, y + 13);
          }
          ctx.stroke();
        }
      }
    });
  }

  function updateNotesTable() {
    notesTableBody.innerHTML = "";
    notes.forEach((note, index) => {
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td');
      tdIndex.textContent = index + 1;

      const tdPitch = document.createElement('td');
      tdPitch.textContent = note.pitch === 'REST' ? 'ä¼‘ç¬¦' : note.pitch;

      const tdDur = document.createElement('td');
      tdDur.textContent = note.duration;

      const tdActions = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = "å‰Šé™¤";
      delBtn.className = "danger";
      delBtn.onclick = () => {
        notes.splice(index, 1);
        syncAll();
      };
      tdActions.appendChild(delBtn);

      tr.appendChild(tdIndex);
      tr.appendChild(tdPitch);
      tr.appendChild(tdDur);
      tr.appendChild(tdActions);

      notesTableBody.appendChild(tr);
    });
  }

  function updateJsonOutput() {
    const data = {
      clef: currentClef,
      tempo: parseInt(tempoInput.value, 10) || 120,
      timeSignature: timeSigSelect.value,
      notes: notes.map(n => ({
        pitch: n.pitch,
        duration: n.duration
      }))
    };
    jsonOutput.value = JSON.stringify(data, null, 2);
  }

  function syncAll() {
    computeLayout();
    updateNotesTable();
    updateJsonOutput();
    drawStaff();
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  clefSelect.addEventListener('change', updateClef);
  
  addNoteBtn.addEventListener('click', () => {
    const pitch = pitchSelect.value;
    const duration = durationSelect.value;
    notes.push({ pitch, duration });
    syncAll();
  });

  clearNotesBtn.addEventListener('click', () => {
    if (notes.length === 0) return;
    if (!confirm("å…¨ã¦ã®éŸ³ç¬¦ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    notes = [];
    syncAll();
  });

  tempoInput.addEventListener('change', syncAll);
  timeSigSelect.addEventListener('change', syncAll);

  copyJsonBtn.addEventListener('click', () => {
    jsonOutput.select();
    document.execCommand('copy');
    copyJsonBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
    setTimeout(() => {
      copyJsonBtn.textContent = "JSON ã‚’ã‚³ãƒ”ãƒ¼ / Copy JSON";
    }, 1200);
  });

  // JSON ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  downloadJsonBtn.addEventListener('click', () => {
    const data = jsonOutput.value;
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `score_${currentClef}_${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // JSON èª­ã¿è¾¼ã¿
  loadJsonBtn.addEventListener("click", () => {
    jsonFileInput.value = "";
    jsonFileInput.click();
  });

  jsonFileInput.addEventListener("change", () => {
    const file = jsonFileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        if (!data.notes || !Array.isArray(data.notes)) {
          alert("JSON ã« 'notes' é…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        // éŸ³éƒ¨è¨˜å·ã‚’è¨­å®š
        if (data.clef) {
          clefSelect.value = data.clef;
          updateClef();
        }

        tempoInput.value = data.tempo || 120;
        if (data.timeSignature) {
          timeSigSelect.value = data.timeSignature;
        } else {
          timeSigSelect.value = "4/4";
        }

        notes = data.notes.map(n => ({
          pitch: n.pitch,
          duration: n.duration
        }));

        syncAll();
        alert("JSON ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
      } catch (err) {
        console.error(err);
        alert("JSON ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };

    reader.readAsText(file);
  });

  // åˆæœŸè¨­å®š
  updateClef();
  syncAll();
</script>
</body>
</html>